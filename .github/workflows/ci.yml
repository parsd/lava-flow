name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  lint_test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Format
        run: cargo fmt --all -- --check

      - name: Clippy (warnings as errors)
        run: cargo clippy --workspace --all-features -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features

  coverage:
    runs-on: ubuntu-latest
    needs: lint_test
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Coverage (workspace)
        run: cargo llvm-cov --workspace --all-features --html

      - name: Coverage summary (json)
        run: cargo llvm-cov report --json --summary-only --output-path target/llvm-cov/coverage.json

      - name: Build docs
        run: cargo doc --workspace --all-features --no-deps

      - name: Prepare pages
        run: |
          mkdir -p public/coverage public/docs
          cp -r target/llvm-cov/html/* public/coverage/
          cp -r target/doc/* public/docs/
          python - <<'PY'
          import json, pathlib
          data = json.loads(pathlib.Path("target/llvm-cov/coverage.json").read_text(encoding="utf-8"))
          percent = None
          try:
              totals = data["data"][0]["totals"]["lines"]
              percent = totals.get("percent")
          except Exception:
              percent = None
          if percent is None:
              percent = 0.0
          message = f"{percent:.1f}%"
          if percent >= 90:
              color = "brightgreen"
          elif percent >= 80:
              color = "green"
          elif percent >= 70:
              color = "yellowgreen"
          elif percent >= 60:
              color = "yellow"
          else:
              color = "red"
          badge = {
              "schemaVersion": 1,
              "label": "coverage",
              "message": message,
              "color": color,
          }
          pathlib.Path("public/coverage.json").write_text(json.dumps(badge), encoding="utf-8")
          pathlib.Path("public/index.html").write_text(
              "<!doctype html>
          <html lang='en'>
          <head><meta charset='utf-8'><title>lava-flow reports</title></head>
          <body>
            <h1>lava-flow reports</h1>
            <ul>
              <li><a href='docs/'>API docs</a></li>
              <li><a href='coverage/'>Coverage report</a></li>
            </ul>
          </body>
          </html>",
              encoding="utf-8",
          )
          PY

      - name: Upload coverage HTML (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: target/llvm-cov/html

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy_pages:
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

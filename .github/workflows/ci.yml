name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  pull-requests: write
  issues: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  lint_test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2

      - name: Format
        run: cargo fmt --all -- --check

      - name: Clippy annotations
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --workspace --all-features -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features

  coverage:
    runs-on: ubuntu-latest
    needs: lint_test
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Coverage (workspace)
        run: cargo llvm-cov --workspace --all-features --html

      - name: Coverage summary (json)
        run: cargo llvm-cov report --json --summary-only --output-path target/llvm-cov/coverage.json

      - name: Build docs
        run: cargo doc --workspace --all-features --no-deps

      - name: Prepare pages
        run: |
          mkdir -p public/coverage public/docs
          cp -r target/llvm-cov/html/* public/coverage/
          cp -r target/doc/* public/docs/
          cat > public/docs/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=lava_flow/">
            <title>lava-flow docs</title>
          </head>
          <body>
            <p>Redirecting to <a href="lava_flow/">lava-flow docs</a>...</p>
          </body>
          </html>
          HTML
          python - <<'PY'
          import json, pathlib
          data = json.loads(pathlib.Path("target/llvm-cov/coverage.json").read_text(encoding="utf-8"))
          percent = None
          try:
              totals = data["data"][0]["totals"]["lines"]
              percent = totals.get("percent")
          except Exception:
              percent = None
          if percent is None:
              percent = 0.0
          message = f"{percent:.1f}%"
          if percent >= 90:
              color = "brightgreen"
          elif percent >= 80:
              color = "green"
          elif percent >= 70:
              color = "yellowgreen"
          elif percent >= 60:
              color = "yellow"
          else:
              color = "red"
          badge = {
              "schemaVersion": 1,
              "label": "coverage",
              "message": message,
              "color": color,
          }
          pathlib.Path("public/coverage.json").write_text(json.dumps(badge), encoding="utf-8")
          pathlib.Path("public/index.html").write_text(
              """<!doctype html>
          <html lang='en'>
          <head><meta charset='utf-8'><title>lava-flow reports</title></head>
          <body>
            <h1>lava-flow reports</h1>
            <ul>
              <li><a href='docs/'>API docs</a></li>
              <li><a href='coverage/'>Coverage report</a></li>
            </ul>
          </body>
          </html>""",
              encoding="utf-8",
          )
          PY

      - name: Extract coverage percent
        id: coverage
        run: |
          python - <<'PY' >> $GITHUB_OUTPUT
          import json, pathlib
          data = json.loads(pathlib.Path("target/llvm-cov/coverage.json").read_text(encoding="utf-8"))
          percent = 0.0
          try:
              percent = data["data"][0]["totals"]["lines"].get("percent", 0.0)
          except Exception:
              percent = 0.0
          print(f"percent={percent:.2f}")
          PY

      - name: Upload coverage HTML (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: target/llvm-cov/html

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const percent = '${{ steps.coverage.outputs.percent }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const coverageArtifact = artifacts.artifacts.find(a => a.name === 'coverage-html');
            const artifactUrl = coverageArtifact ? coverageArtifact.archive_download_url : runUrl;
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/coverage/`;
            let mainPercent = null;
            try {
              const resp = await fetch(`https://${context.repo.owner}.github.io/${context.repo.repo}/coverage.json`, { cache: 'no-store' });
              if (resp.ok) {
                const data = await resp.json();
                const msg = (data && data.message) ? data.message : '';
                mainPercent = parseFloat(String(msg).replace('%',''));
              }
            } catch (e) {
              mainPercent = null;
            }

            let deltaLine = '- Main coverage (Pages): unavailable';
            if (typeof mainPercent === 'number' && !Number.isNaN(mainPercent)) {
              const pr = parseFloat(percent);
              const delta = (pr - mainPercent);
              const color = delta >= 0 ? 'ðŸŸ¢' : 'ðŸ”´';
              const sign = delta >= 0 ? '+' : '';
              deltaLine = `- Main coverage (Pages): **${mainPercent.toFixed(2)}%** (${color} ${sign}${delta.toFixed(2)}%)`;
            }

            const body = [
              'Coverage report for this PR:',
              `- Line coverage: **${percent}%**`,
              deltaLine,
              `- HTML report artifact (download): ${artifactUrl}`,
              `- Pages (main branch only): ${pagesUrl}`,
              `- Workflow run: ${runUrl}`
            ].join('\\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.user?.type === 'Bot' && c.body?.startsWith('Coverage report for this PR:'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  deploy_pages:
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


